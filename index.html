<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exocortex Game Tracker Template - Universal Checklist</title>
    <style>
        /* Console Aesthetic */
        body {
            font-family: 'Roboto Mono', monospace, sans-serif;
            background-color: #000000;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #0a0a0a;
            padding: 30px;
            border-radius: 6px;
            box-shadow: 0 0 30px rgba(0, 255, 170, 0.2);
        }
        h1 {
            color: #00ffaa;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-bottom: 30px;
            text-transform: uppercase;
        }
        h2 {
            color: #d0d0d0;
            border-bottom: 1px solid #222;
            padding-bottom: 5px;
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: 500;
        }
        .control-group {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #1f1f1f;
            border-radius: 4px;
        }
        input[type="text"] {
            width: 70%;
            padding: 10px;
            border: 1px solid #333;
            background-color: #1a1a1a;
            color: #ffffff;
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
        }
        .load-button {
            width: 25%;
            padding: 10px;
            background-color: #ff3d00;
            color: #000000;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            float: right;
        }
        .load-button:hover { background-color: #ff6e40; }
        
        /* Checklist Styles */
        .talisman-item {
            padding: 8px 0;
            border-bottom: 1px dashed #1f1f1f;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        .talisman-item.acquired {
            background-color: #111111;
            opacity: 0.6;
        }
        .talisman-item label {
            flex-grow: 1;
            margin-left: 10px;
            cursor: pointer;
        }
        .talisman-item a {
            color: #00ffaa;
            text-decoration: none;
        }
        .talisman-item a:hover {
            text-decoration: underline;
        }
        input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>GAMER EXOCORTEX: UNIVERSAL CHECKLIST</h1>
    
    <div class="control-group">
        <h2>DATA SOURCE INPUT (The Game Switch)</h2>
        <label>Paste Public CSV URL Here (Must contain ID, NAME, LOCATION_BRIEF, LOCATION_LINK headers)</label>
        <input type="text" id="csv-url-input" placeholder="e.g., https://docs.google.com/spreadsheets/d/.../pub?output=csv">
       <button class="load-button" style="width:48%; margin-top:10px; background-color: #0080ff;" onclick="saveGame()">SAVE NEW GAME</button>
       <button class="load-button" style="width:48%; margin-top:10px;" onclick="loadGameFromInput()">LOAD GAME â†’ ACTIVATE</button>
    </div>

    <div class="control-group" id="checklist-output-group" style="display:none;">
        <h2>ITEM TRACKER <span id="game-name-display" style="color:#00ffaa;"></span></h2>
        <p style="color:#aaa;">Total Items: <span id="talisman-count">0</span> | Acquired: <span id="acquired-count">0</span> | <button onclick="clearLocalStorage()" style="background: none; border: none; color: #ff3d00; cursor: pointer; padding: 0;">(CLEAR DATA)</button></p>
        <div id="talisman-list-container" style="max-height: 500px; overflow-y: auto;">
            </div>
    </div>

</div>

// Global variable to store all fetched items
let allItems = [];
const LOCAL_STORAGE_KEY = 'EXOCORTEX_CHECKLIST_PROGRESS'; // Universal storage key

// --- CORE LOGIC ---

// 1. Fetch CSV data based on the URL input
async function fetchTalismanData() {
    const csvUrl = document.getElementById('csv-url-input').value.trim();
    if (!csvUrl) {
        alert("ERROR: CSV URL is empty. Cannot load game data.");
        return;
    }
    
    document.getElementById('checklist-output-group').style.display = 'block';
    document.getElementById('talisman-list-container').innerHTML = "<p style='text-align: center; color:#00ffaa;'>LOADING DATA...</p>";

    try {
        const response = await fetch(csvUrl);
        const csvText = await response.text();
        
        // Use the robust parsing function
        allItems = parseCSV(csvText);
        
        // Auto-detect game name from the URL or a simple placeholder
        const gameNamePlaceholder = csvUrl.split('/')[5] || 'Unknown Game';
        document.getElementById('game-name-display').innerText = `[${gameNamePlaceholder.toUpperCase().replace(/_/g, ' ')}]`;
        
        renderItemList();
    } catch (error) {
        console.error("Error fetching or parsing data:", error);
        document.getElementById('talisman-list-container').innerHTML = `<p style='color:red; text-align: center;'>FATAL ERROR: Parsing Failed. Check Console for details. (Did you use the required headers: TALISMAN_ID, NAME, LOCATION_BRIEF, LOCATION_LINK?)</p>`;
    }
}

// 2. ROBUST CSV PARSING FUNCTION (The Fix)
function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) throw new Error("CSV has no data rows.");
    
    // Use regex to split headers and clean them up
    let headers = lines[0].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || lines[0].split(',');
    headers = headers.map(h => h.replace(/"/g, '').trim().toUpperCase());

    const data = [];
    const requiredHeaders = ['TALISMAN_ID', 'NAME', 'LOCATION_BRIEF', 'LOCATION_LINK'];
    
    // Check for required headers rigorously
    if (!requiredHeaders.every(h => headers.includes(h))) {
        throw new Error(`Invalid CSV headers. Required: ${requiredHeaders.join(', ')}`);
    }

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        // Use regex for values to handle embedded commas/quotes in data
        const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
        if (!values || values.length !== headers.length) {
             // Skip malformed line, but log it
             console.warn(`Skipping malformed data line: ${line}`);
             continue;
        }

        let item = {};
        for (let j = 0; j < headers.length; j++) {
            item[headers[j]] = values[j] ? values[j].replace(/"/g, '').trim() : ''; 
        }
        data.push(item);
    }
    return data;
}

// 3. Render the list dynamically
function renderItemList() {
    const container = document.getElementById('talisman-list-container');
    container.innerHTML = '';
    const acquiredList = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [];
    let acquiredCount = 0;

    // Sort items by name (optional QoL feature)
    allItems.sort((a, b) => a.NAME.localeCompare(b.NAME));

    allItems.forEach(item => {
        const itemId = item.TALISMAN_ID;
        const isAcquired = acquiredList.includes(itemId);
        if (isAcquired) acquiredCount++;
        
        const itemHtml = `
            <div id="${itemId}" class="talisman-item ${isAcquired ? 'acquired' : ''}">
                <input type="checkbox" id="check-${itemId}" 
                       ${isAcquired ? 'checked' : ''} 
                       onclick="toggleItem('${itemId}')">
                <label for="check-${itemId}">
                    <strong>${item.NAME}</strong> - 
                    <a href="${item.LOCATION_LINK}" target="_blank">${item.LOCATION_BRIEF}</a>
                </label>
            </div>
        `;
        container.innerHTML += itemHtml;
    });

    document.getElementById('talisman-count').innerText = allItems.length;
    document.getElementById('acquired-count').innerText = acquiredCount;
}

// 4. Toggle Item Status and Save to Local Storage
function toggleItem(itemId) {
    let acquiredList = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [];
    const index = acquiredList.indexOf(itemId);

    if (index > -1) {
        acquiredList.splice(index, 1); 
    } else {
        acquiredList.push(itemId);
    }

    // Save the updated list
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(acquiredList));
    renderItemList(); // Re-render to update the display
}
    
// 5. Clear Data Function (Branson's 'New Game' button)
function clearLocalStorage() {
    if (confirm("WARNING: This will CLEAR all saved progress for this checklist. Proceed?")) {
        localStorage.removeItem(LOCAL_STORAGE_KEY);
        renderItemList(); // Re-render to show empty list
        console.log("Local storage cleared. New Game started.");
    }
}

// Initial setup: Add event listener to the button instead of running on load
document.addEventListener('DOMContentLoaded', () => {
    // We don't run fetchTalismanData here; we rely only on the button click.
    console.log("Exocortex Console Ready. Paste CSV link and click ACTIVATE.");
});

